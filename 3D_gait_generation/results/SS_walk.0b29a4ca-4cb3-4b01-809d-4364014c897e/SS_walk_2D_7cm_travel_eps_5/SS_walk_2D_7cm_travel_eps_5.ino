//Gait template
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pca9685 = Adafruit_PWMServoDriver();

#define SERVO_FREQ 50
#define SER0 0 //Hip 1
#define SER1 1 //Knee 1
#define SER2 2 //Hip 2
#define SER3 3 //Knee 2
#define SER4 4 //Hip 3
#define SER5 5 //Knee 3
#define SER6 6 //Hip 4
#define SER7 7 //Knee 4

float SS_servo0[] = {-0.4569285477180139, -0.5102989913438876, -0.5075002925583688, -0.4346785471033481, -0.3473045230924239, -0.2611237984497226, -0.18033035990311283, -0.09332500084436497, -0.009771319356525473, 0.047463374584667484, 0.04977662276375921, 0.018941840341404316, -0.008829343170853574, -0.02780111974647987, -0.040738839893974615, -0.0487886327323428, -0.05480876461549391, -0.06278652530479262, -0.07243980596238417, -0.08319694702976688, -0.0989672854162673, -0.11310523864987093, -0.12957670998712223, -0.15042243866882146, -0.16961063973940477, -0.18865409569656202, -0.21089359608715602, -0.23702147813743712, -0.2647000349945416, -0.29243854282402953, -0.3209948182955856, -0.34627659571399927, -0.36640917435105747, -0.3790030989041592, -0.38718039787755415, -0.3902643365489158, -0.3893650619451243, -0.3833136048350609, -0.36962903762241267};
float SS_servo1[] = {0.5365365415120535, 0.5446568475891804, 0.5827154158391857, 0.7298834042688622, 0.85464609605628, 0.8884096658786369, 0.903721456967184, 0.9184572617063201, 0.931897274735509, 0.9208432574812572, 0.8927543932772456, 0.9021628134869359, 0.9015445223686798, 0.8925240858363384, 0.8841017497288517, 0.8712150967708429, 0.8530149179764662, 0.8308224180736252, 0.7950138558475642, 0.7532481687403432, 0.726604628063759, 0.6853000247069636, 0.6563837120021039, 0.6551216912459372, 0.6581902092990197, 0.6556164853441218, 0.6552097485075483, 0.6564631744810919, 0.6580225777035945, 0.6683795993867975, 0.6790812812290237, 0.6866093720410885, 0.6944318584125486, 0.6878371872735372, 0.6752712930428321, 0.6556179148033484, 0.617526045310625, 0.5555078560245758, 0.4860659365296864};
float SS_servo2[] = {-0.1779953945596307, -0.23621522732670228, -0.27332928742321644, -0.29826722858635923, -0.3165860213703679, -0.33538394866343885, -0.3534013303863633, -0.37287837756058234, -0.3923470934660155, -0.4130193449874959, -0.43438928951065864, -0.45636038676981555, -0.47377504249179264, -0.4856911440987766, -0.49191746392759755, -0.4944473263638312, -0.49491209686822846, -0.49831641059290543, -0.5021253246620583, -0.4770879358355079, -0.43773874002532265, -0.42515832218208033, -0.3924453933623214, -0.3239354376106394, -0.23726277398376439, -0.15232730496585142, -0.07927378205542353, -0.03144683327358944, -0.010072138401348123, 0.012968258528506828, 0.009930935891979485, -0.02480397611820771, -0.05175987806087998, -0.06981027176932493, -0.0828234588381027, -0.09018183745366808, -0.09352861260044254, -0.09304550383644264, -0.08512036637425775};
float SS_servo3[] = {0.6818785784304617, 0.702205031713518, 0.7018249312104616, 0.7099668413380926, 0.7155013948519164, 0.7154368751092767, 0.7165923846280262, 0.7245036012955192, 0.7359427436081714, 0.744919105165228, 0.7430498412153727, 0.7366632224273764, 0.7211231758663287, 0.7034183859225418, 0.6876950630094562, 0.6702927390554104, 0.6487828681913644, 0.6244238915536212, 0.586854897806841, 0.5834816404512255, 0.6241935802816332, 0.5665075672542096, 0.5650215534145095, 0.6945171235818892, 0.8235083516441012, 0.8773345388009397, 0.8921018975269908, 0.8734155624023843, 0.8216554147317112, 0.779250487817856, 0.7621972938041967, 0.7848372952512834, 0.8039713113048311, 0.8048803510728184, 0.797688706521996, 0.7813153667278396, 0.7445662258543269, 0.6827065623752766, 0.6123910051180596};
float SS_servo4[] = {0.47364359429765535, 0.5000197151586362, 0.5049536349614154, 0.5038231213145965, 0.497587297589633, 0.4833600789753591, 0.4640621376414281, 0.44008306177431555, 0.41173143146556707, 0.37920160328559643, 0.3451845096215968, 0.3126324863738601, 0.28259662779437156, 0.25552951183495676, 0.22833814035938074, 0.20287445741165927, 0.18155218848761415, 0.1645169828272344, 0.15149098586142973, 0.13863366303327054, 0.11866659433070222, 0.10380569057077073, 0.0866376344406346, 0.07296442675912959, 0.06116304603985416, 0.0452874238117689, 0.02270679248611978, -0.012485615010621124, -0.03297206831640677, -0.00870531624090177, 0.02702283597907046, 0.08943237259392187, 0.1795561091399862, 0.2554835235975329, 0.3304686948652811, 0.4052177098240612, 0.4461225985184818, 0.4273396604872425, 0.38485343166911423};
float SS_servo5[] = {-0.5212273167541221, -0.5946167999363935, -0.6415396791865051, -0.6613319862418209, -0.6707292295279765, -0.6766555468306039, -0.6742803814660273, -0.661311843298888, -0.639576949335718, -0.6163534520605654, -0.6019873925275293, -0.5939898591739055, -0.5926234376434029, -0.5908198797674493, -0.5808482597508278, -0.5705600755010701, -0.56706486773579, -0.5745454310278864, -0.6016114264479374, -0.6358074993687407, -0.655356175544229, -0.6943847711552276, -0.7216218488174929, -0.7308623903213058, -0.7362947745555529, -0.7423139959204124, -0.7415996383334178, -0.7283236830040998, -0.7333859290480612, -0.7808480004053114, -0.8308119596047028, -0.8525295816630387, -0.8171606840080005, -0.7581043242427289, -0.6422890457058467, -0.4801210142503354, -0.3673787808772915, -0.38863132216972873, -0.3981175059991556};
float SS_servo6[] = {0.17092161144642884, 0.18972512299401087, 0.18771509969843445, 0.18157474540428173, 0.17111523729869393, 0.15164456099707996, 0.12699501118174636, 0.09594702468429266, 0.06178875794340937, 0.04628077529538297, 0.06395570455464814, 0.09058022958077239, 0.1214633615778362, 0.17198529828453765, 0.2422468079172404, 0.3164428134154877, 0.3932847890198248, 0.4665972429189678, 0.51338910906733, 0.5121974972984557, 0.4977832212564198, 0.4906876573649293, 0.48091510510414515, 0.47251619038021225, 0.46539940528049767, 0.45597245601436165, 0.4409644017780173, 0.4179617521774258, 0.38991759583830193, 0.362895492604266, 0.3352938915647778, 0.30830265863124817, 0.2802544136140613, 0.25447909877878466, 0.22639743004841206, 0.19889472295142038, 0.16926960070006664, 0.13065663016310522, 0.07930242289841384};
float SS_servo7[] = {-0.6827841843210913, -0.7599948173033924, -0.8059133246866848, -0.8230163285729851, -0.8282619616063509, -0.826882338922007, -0.8150169335271107, -0.7886033912187801, -0.7539845211598908, -0.746266008424373, -0.7838247141173107, -0.8298170343930156, -0.8796759318771465, -0.8924301623591292, -0.821835474610532, -0.697226559062505, -0.5595173687656745, -0.43991659800946575, -0.3956579007756558, -0.4305969266445157, -0.4555416990203532, -0.49961252946196555, -0.5335035421933584, -0.5492746693381036, -0.5607564594270825, -0.574934462042986, -0.5850687400126664, -0.5899877858951122, -0.5904103754838488, -0.5838388552981217, -0.5763538465278899, -0.5677253252748186, -0.5514217952039988, -0.5423676264003997, -0.5311061660212997, -0.5218532821386637, -0.525297608338939, -0.5379444453997151, -0.5358258912856181};

int node=0;
int first=0;
int input=0;
int end_time=0;
int time_step=80000;
int steps = sizeof(SS_servo0)/sizeof(SS_servo0[0]);

// ------------------------Centers:--------------------------
int centre0=312;
int centre1=293;
int centre2=305;
int centre3=315;
int centre4=315;
int centre5=300;
int centre6=310;
int centre7=315;

// -------------------Joint configurations-------------------
int servo0=0;
int servo0_deg=0;
int servo1=0;
int servo1_deg=0;
int servo2=0;
int servo2_deg=0;
int servo3=0;
int servo3_deg=0;
int servo4=0;
int servo4_deg=0;
int servo5=0;
int servo5_deg=0;
int servo6=0;
int servo6_deg=0;
int servo7=0;
int servo7_deg=0;

void setup() {
  Serial.begin(115200);
  pca9685.begin();

  pca9685.setOscillatorFrequency(27000000); //Value between 24MHz and 27MHz, tuned for this setup
  pca9685.setPWMFreq(SERVO_FREQ);
  delay (500);

  servo0_deg=SS_servo0[0]/3.14159265*180;
  servo0=map(servo0_deg,30,-30,265,355);
  pca9685.setPWM(SER0,0,servo0);

  servo1_deg=SS_servo1[0]/3.14159265*180;
  servo1=map(servo1_deg,30,-30,250,335);
  pca9685.setPWM(SER1,0,servo1);

  servo2_deg=SS_servo2[0]/3.14159265*180;
  servo2=map(servo2_deg,-30,30,265,350);
  pca9685.setPWM(SER2,0,servo2);

  servo3_deg=SS_servo3[0]/3.14159265*180;
  servo3=map(servo3_deg,-30,30,265,360);
  pca9685.setPWM(SER3,0,servo3);

  servo4_deg=SS_servo4[0]/3.14159265*180;
  servo4=map(servo4_deg,30,-30,265,360);
  pca9685.setPWM(SER4,0,servo4);

  servo5_deg=SS_servo5[0]/3.14159265*180;
  servo5=map(servo5_deg,30,-30,250,345);
  pca9685.setPWM(SER5,0,servo5);

  servo6_deg=SS_servo6[0]/3.14159265*180;
  servo6=map(servo6_deg,-30,30,260,355);
  pca9685.setPWM(SER6,0,servo6);

  servo7_deg=SS_servo7[0]/3.14159265*180;
  servo7=map(servo7_deg,-30,30,265,365);
  pca9685.setPWM(SER7,0,servo7);
  
  Serial.println("Ready Steady");
  end_time=esp_timer_get_time()+time_step;
  Serial.println("Hip last entry");
  Serial.println(SS_servo6[steps]);
  Serial.println("Knee last entry");
  Serial.println(SS_servo7[steps]);
  
}

void loop() 
{
  if(Serial.available()>0)
  {
    first=Serial.read();
    if(first=='1')
    {
      input=1;
    }
    if(first=='0')
    {
      input=0;
    }
  }
  if(input==1)
  {
      if(esp_timer_get_time()>=end_time)
      {
        servo0_deg=SS_servo0[node]/3.14159265*180;
        servo0=map(servo0_deg,30,-30,265,355);
        pca9685.setPWM(SER0,0,servo0);

        servo1_deg=SS_servo1[node]/3.14159265*180;
        servo1=map(servo1_deg,30,-30,250,335);
        pca9685.setPWM(SER1,0,servo1);

        servo2_deg=SS_servo2[node]/3.14159265*180;
        servo2=map(servo2_deg,-30,30,265,350);
        pca9685.setPWM(SER2,0,servo2);

        servo3_deg=SS_servo3[node]/3.14159265*180;
        servo3=map(servo3_deg,-30,30,265,360);
        pca9685.setPWM(SER3,0,servo3);

        servo4_deg=SS_servo4[node]/3.14159265*180;
        servo4=map(servo4_deg,30,-30,265,360);
        pca9685.setPWM(SER4,0,servo4);

        servo5_deg=SS_servo5[node]/3.14159265*180;
        servo5=map(servo5_deg,30,-30,250,345);
        pca9685.setPWM(SER5,0,servo5);

        servo6_deg=SS_servo6[node]/3.14159265*180;
        servo6=map(servo6_deg,-30,30,260,355);
        pca9685.setPWM(SER6,0,servo6);

        servo7_deg=SS_servo7[node]/3.14159265*180;
        servo7=map(servo7_deg,-30,30,265,365);
        pca9685.setPWM(SER7,0,servo7);
     
//        Serial.print("Node:");
//        Serial.print(node);
//        Serial.print("       SS_servo0:");
//        Serial.println(SS_servo3[node]);
        node+=1;
        if(node>=steps)
           {
              Serial.print("1 cycle");
              node=0;
            }
         end_time=esp_timer_get_time()+time_step;
      }
   }

  if(input == 0)
  {
   servo0_deg=SS_servo0[node]/3.14159265*180;
   servo0=map(servo0_deg,30,-30,265,355);
   pca9685.setPWM(SER0,0,servo0);

   servo1_deg=SS_servo1[node]/3.14159265*180;
   servo1=map(servo1_deg,30,-30,250,335);
   pca9685.setPWM(SER1,0,servo1);

   servo2_deg=SS_servo2[node]/3.14159265*180;
   servo2=map(servo2_deg,-30,30,265,350);
   pca9685.setPWM(SER2,0,servo2);

   servo3_deg=SS_servo3[node]/3.14159265*180;
   servo3=map(servo3_deg,-30,30,265,360);
   pca9685.setPWM(SER3,0,servo3);

   servo4_deg=SS_servo4[node]/3.14159265*180;
   servo4=map(servo4_deg,30,-30,265,360);
   pca9685.setPWM(SER4,0,servo4);
 
   servo5_deg=SS_servo5[node]/3.14159265*180;
   servo5=map(servo5_deg,30,-30,250,345);
   pca9685.setPWM(SER5,0,servo5);

   servo6_deg=SS_servo6[node]/3.14159265*180;
   servo6=map(servo6_deg,-30,30,260,355);
   pca9685.setPWM(SER6,0,servo6);

   servo7_deg=SS_servo7[node]/3.14159265*180;
   servo7=map(servo7_deg,-30,30,265,365);
   pca9685.setPWM(SER7,0,servo7);
  
  }
}
