//Gait template
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pca9685 = Adafruit_PWMServoDriver();

#define SERVO_FREQ 50
#define SER0 0 //Hip 1
#define SER1 1 //Knee 1
#define SER2 2 //Hip 2
#define SER3 3 //Knee 2
#define SER4 4 //Hip 3
#define SER5 5 //Knee 3
#define SER6 6 //Hip 4
#define SER7 7 //Knee 4

float SS_servo0[] = {-0.45227126733867046, -0.4665764996623166, -0.39619769649832737, -0.3130584142155495, -0.2290211365661797, -0.16343547772097924, -0.1814689857221172, -0.19962034057732292, -0.21029742569718193, -0.2203604157888484, -0.2315018134205876, -0.24180187388786378, -0.2488273451633498, -0.25455414986182184, -0.2590442523625881, -0.264234909313342, -0.27069826422780136, -0.27860012547419954, -0.2878709214072506, -0.29708931339293954, -0.3096250262297208, -0.3257501549448424, -0.34533159076838327, -0.3672820358037822, -0.39181485942218425, -0.42032190630085897, -0.4462384251773384, -0.4609445222209414, -0.4700262671872576, -0.47598621335643004, -0.4775588637580572, -0.4748442280179547, -0.470914276693238, -0.46523761301432676, -0.4561948016884171, -0.44255420360411396, -0.42668367667584545, -0.40719119372814805, -0.3807814979203859};
float SS_servo1[] = {0.30510558771558516, 0.333467420077766, 0.4793038477273249, 0.6509053392384792, 0.7801103927816015, 0.7848175642704166, 0.805367680012847, 0.8106815920171135, 0.8004593550913858, 0.7879486775773802, 0.7757023296151131, 0.764969688849173, 0.755353250100601, 0.7482919947377318, 0.7454479067808164, 0.7433422562566583, 0.7412708190996327, 0.7396165936267098, 0.7372134145315464, 0.7326547144503569, 0.7313464643086582, 0.7336500697995918, 0.7429358459235124, 0.7563224295655798, 0.7673807653793534, 0.7723013689832854, 0.7647884356192541, 0.7356159503758258, 0.6978141238897938, 0.6598178412574401, 0.6289850518803031, 0.6060848940309758, 0.5777117053084599, 0.5458358502151125, 0.5136731431373601, 0.484874061098934, 0.44642864228969714, 0.3912366654708473, 0.3366086788319911};
float SS_servo2[] = {-0.23236003175503284, -0.3011985062016851, -0.345645490999066, -0.38589453354819153, -0.41972248254531, -0.4493091503581661, -0.47342260021128457, -0.47951119648485063, -0.47958155620344056, -0.4795531440785172, -0.4808291325199853, -0.4822940739424452, -0.4834752739906264, -0.48482603698847127, -0.48589299356673943, -0.4886677606395074, -0.4936446844820557, -0.5010473064324179, -0.5108901162345163, -0.4851526352097549, -0.403965808068182, -0.3228073669121172, -0.23713323748224455, -0.1482942565338163, -0.08431185696979689, -0.06648105959298806, -0.09234800589907215, -0.12272142244296061, -0.1491465638942483, -0.1716784745296084, -0.1851810660137163, -0.19058905944731905, -0.19492341548318723, -0.19713996885645457, -0.19510573556164612, -0.18544023993590134, -0.17521280887646787, -0.16825237904577883, -0.1517417313609514};
float SS_servo3[] = {0.5570936354808272, 0.5571745825081665, 0.5749234074626441, 0.6056117925494934, 0.6474760444482597, 0.6921421638739436, 0.7135708907577916, 0.7022777132821644, 0.6792245666548327, 0.6547160736743906, 0.6313960633940773, 0.6109769512476658, 0.595193609673276, 0.583407127375485, 0.5766231875861761, 0.5714256403493123, 0.5670985645032399, 0.5638971474441301, 0.5610329751074832, 0.604140894786342, 0.7230143784032909, 0.8237293607540284, 0.9132175738474392, 0.9711240595450977, 0.9728526381328204, 0.9158126075714115, 0.9092071834754114, 0.9012737669588188, 0.884121078183912, 0.8646463650468248, 0.8451532578130104, 0.8281218932330155, 0.8048338650346799, 0.7767769625331257, 0.7469950243707438, 0.7163055114676937, 0.6768846554518196, 0.6271953207092076, 0.5748121640691115};
float SS_servo4[] = {0.45499312681466436, 0.4582975785434539, 0.4637628288826385, 0.47168704245050064, 0.4779388417084762, 0.47423424864528807, 0.4602676717530039, 0.4442793923372392, 0.42623599029603093, 0.4059156787827429, 0.38317890624836237, 0.3610501497574329, 0.3433762105600274, 0.3269659185740098, 0.3123942241644208, 0.2974015022824369, 0.28192024965270734, 0.2662636897660955, 0.2519078097732249, 0.24272413818662517, 0.23096211614819118, 0.21759424759899634, 0.20445712620996878, 0.19064363570599568, 0.17065748233502906, 0.14027862487857753, 0.10569600673380923, 0.06899521899992261, 0.027964187546172845, 0.010065334916675127, 0.0529963112928182, 0.13241491481382986, 0.20836686005399743, 0.2813367165495882, 0.3482896212223269, 0.4201990069479346, 0.4608327945045892, 0.43095169897844215, 0.39363597169938147};
float SS_servo5[] = {-0.7776489798168764, -0.8710398210978179, -0.917941454729309, -0.9483070447522, -0.9565104993931106, -0.942536069647044, -0.9321316677691052, -0.9319819006864816, -0.9351314062518178, -0.937520055168266, -0.9375813260248237, -0.935773302660249, -0.9340345139408122, -0.929114850818711, -0.9199588370188362, -0.9101169060662727, -0.9012159762570531, -0.8935034857804363, -0.8902846422338324, -0.896533109324534, -0.9001348291112218, -0.902184946025104, -0.901363899870412, -0.8980399812420223, -0.8912463538776183, -0.8800464485203421, -0.8712074267106467, -0.8692736202155893, -0.864915788062478, -0.8885852833659429, -0.9288202383878947, -0.9234074209311341, -0.9228499299593956, -0.911587994483607, -0.8464121487910751, -0.7057786385435849, -0.6047754079464702, -0.6038008742510961, -0.5972669485028603};
float SS_servo6[] = {0.16261415075981303, 0.14939534288603315, 0.14007557884445468, 0.1333806387345972, 0.12674984822369992, 0.11298640919582055, 0.08968033734502688, 0.06513322268377719, 0.03903847414752246, 0.010766222905189336, -0.020266603803821094, -0.030889998614905836, -0.0032604995571553766, 0.04517988021115984, 0.1185393159886875, 0.19649516985573412, 0.2743986712511423, 0.35155526321660063, 0.4325670543930107, 0.49881057374113996, 0.49651792983311854, 0.49004592573068484, 0.48429473306388393, 0.4778122049185918, 0.46639142774273834, 0.4480547734187268, 0.42719098265365496, 0.40497895770566306, 0.3795732629770751, 0.35314609754034293, 0.3297217465522537, 0.3069468096137689, 0.28511623733989155, 0.26453047642519123, 0.24407148642048185, 0.22507800494605495, 0.20086109758834883, 0.16390099537911662, 0.12398464213881814};
float SS_servo7[] = {-1.0194149829598615, -1.1138102019180605, -1.1515277410361224, -1.1673389434736168, -1.1548550146756962, -1.1160700593361363, -1.0820225292210635, -1.062545779177745, -1.0481813911493145, -1.0327569458856163, -1.013988703337042, -1.021755819842611, -1.069348672984206, -1.1038027413500364, -1.1031891750845415, -1.0689308370974204, -1.0018762499165044, -0.8997734380331247, -0.7790837095783729, -0.7204892428698932, -0.7278693345655964, -0.7396216919217445, -0.7490137806720086, -0.7559363121183575, -0.7627709488458166, -0.7719425151021982, -0.78509122564104, -0.805666983123071, -0.8260698519945497, -0.8432318389031221, -0.8515323037349853, -0.8462091569383676, -0.8468202522804565, -0.8512802774525582, -0.8522511226442228, -0.8459489477406763, -0.8429974949688357, -0.8398352736965167, -0.8236085321391082};

int node=0;
int first=0;
int input=0;
int end_time=0;
int time_step=60000;
int steps = sizeof(SS_servo0)/sizeof(SS_servo0[0]);

// ------------------------Centers:--------------------------
int centre0=312;
int centre1=293;
int centre2=305;
int centre3=315;
int centre4=315;
int centre5=300;
int centre6=310;
int centre7=315;

// -------------------Joint configurations-------------------
int servo0=0;
int servo0_deg=0;
int servo1=0;
int servo1_deg=0;
int servo2=0;
int servo2_deg=0;
int servo3=0;
int servo3_deg=0;
int servo4=0;
int servo4_deg=0;
int servo5=0;
int servo5_deg=0;
int servo6=0;
int servo6_deg=0;
int servo7=0;
int servo7_deg=0;

void setup() {
  Serial.begin(115200);
  pca9685.begin();

  pca9685.setOscillatorFrequency(27000000); //Value between 24MHz and 27MHz, tuned for this setup
  pca9685.setPWMFreq(SERVO_FREQ);
  delay (500);

  servo0_deg=SS_servo0[0]/3.14159265*180;
  servo0=map(servo0_deg,30,-30,265,355);
  pca9685.setPWM(SER0,0,servo0);

  servo1_deg=SS_servo1[0]/3.14159265*180;
  servo1=map(servo1_deg,30,-30,250,335);
  pca9685.setPWM(SER1,0,servo1);

  servo2_deg=SS_servo2[0]/3.14159265*180;
  servo2=map(servo2_deg,-30,30,265,350);
  pca9685.setPWM(SER2,0,servo2);

  servo3_deg=SS_servo3[0]/3.14159265*180;
  servo3=map(servo3_deg,-30,30,265,360);
  pca9685.setPWM(SER3,0,servo3);

  servo4_deg=SS_servo4[0]/3.14159265*180;
  servo4=map(servo4_deg,30,-30,265,360);
  pca9685.setPWM(SER4,0,servo4);

  servo5_deg=SS_servo5[0]/3.14159265*180;
  servo5=map(servo5_deg,30,-30,250,345);
  pca9685.setPWM(SER5,0,servo5);

  servo6_deg=SS_servo6[0]/3.14159265*180;
  servo6=map(servo6_deg,-30,30,260,355);
  pca9685.setPWM(SER6,0,servo6);

  servo7_deg=SS_servo7[0]/3.14159265*180;
  servo7=map(servo7_deg,-30,30,265,365);
  pca9685.setPWM(SER7,0,servo7);
  
  Serial.println("Ready Steady");
  end_time=esp_timer_get_time()+time_step;
  Serial.println("Hip last entry");
  Serial.println(SS_servo6[steps]);
  Serial.println("Knee last entry");
  Serial.println(SS_servo7[steps]);
  
}

void loop() 
{
  if(Serial.available()>0)
  {
    first=Serial.read();
    if(first=='1')
    {
      input=1;
    }
    if(first=='0')
    {
      input=0;
    }
  }
  if(input==1)
  {
      if(esp_timer_get_time()>=end_time)
      {
        servo0_deg=SS_servo0[node]/3.14159265*180;
        servo0=map(servo0_deg,30,-30,265,355);
        pca9685.setPWM(SER0,0,servo0);

        servo1_deg=SS_servo1[node]/3.14159265*180;
        servo1=map(servo1_deg,30,-30,250,335);
        pca9685.setPWM(SER1,0,servo1);

        servo2_deg=SS_servo2[node]/3.14159265*180;
        servo2=map(servo2_deg,-30,30,265,350);
        pca9685.setPWM(SER2,0,servo2);

        servo3_deg=SS_servo3[node]/3.14159265*180;
        servo3=map(servo3_deg,-30,30,265,360);
        pca9685.setPWM(SER3,0,servo3);

        servo4_deg=SS_servo4[node]/3.14159265*180;
        servo4=map(servo4_deg,30,-30,265,360);
        pca9685.setPWM(SER4,0,servo4);

        servo5_deg=SS_servo5[node]/3.14159265*180;
        servo5=map(servo5_deg,30,-30,250,345);
        pca9685.setPWM(SER5,0,servo5);

        servo6_deg=SS_servo6[node]/3.14159265*180;
        servo6=map(servo6_deg,-30,30,260,355);
        pca9685.setPWM(SER6,0,servo6);

        servo7_deg=SS_servo7[node]/3.14159265*180;
        servo7=map(servo7_deg,-30,30,265,365);
        pca9685.setPWM(SER7,0,servo7);
     
//        Serial.print("Node:");
//        Serial.print(node);
//        Serial.print("       SS_servo0:");
//        Serial.println(SS_servo3[node]);
        node+=1;
        if(node>=steps)
           {
              Serial.print("1 cycle");
              node=0;
            }
         end_time=esp_timer_get_time()+time_step;
      }
   }

  if(input == 0)
  {
   servo0_deg=SS_servo0[node]/3.14159265*180;
   servo0=map(servo0_deg,30,-30,265,355);
   pca9685.setPWM(SER0,0,servo0);

   servo1_deg=SS_servo1[node]/3.14159265*180;
   servo1=map(servo1_deg,30,-30,250,335);
   pca9685.setPWM(SER1,0,servo1);

   servo2_deg=SS_servo2[node]/3.14159265*180;
   servo2=map(servo2_deg,-30,30,265,350);
   pca9685.setPWM(SER2,0,servo2);

   servo3_deg=SS_servo3[node]/3.14159265*180;
   servo3=map(servo3_deg,-30,30,265,360);
   pca9685.setPWM(SER3,0,servo3);

   servo4_deg=SS_servo4[node]/3.14159265*180;
   servo4=map(servo4_deg,30,-30,265,360);
   pca9685.setPWM(SER4,0,servo4);
 
   servo5_deg=SS_servo5[node]/3.14159265*180;
   servo5=map(servo5_deg,30,-30,250,345);
   pca9685.setPWM(SER5,0,servo5);

   servo6_deg=SS_servo6[node]/3.14159265*180;
   servo6=map(servo6_deg,-30,30,260,355);
   pca9685.setPWM(SER6,0,servo6);

   servo7_deg=SS_servo7[node]/3.14159265*180;
   servo7=map(servo7_deg,-30,30,265,365);
   pca9685.setPWM(SER7,0,servo7);
  
  }
}
