//Gait template
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pca9685 = Adafruit_PWMServoDriver();

#define SERVO_FREQ 50
#define SER0 0 //Hip 1
#define SER1 1 //Knee 1
#define SER2 2 //Hip 2
#define SER3 3 //Knee 2
#define SER4 4 //Hip 3
#define SER5 5 //Knee 3
#define SER6 6 //Hip 4
#define SER7 7 //Knee 4

float SS_servo0[] = {-0.3068659375546563, -0.3654551901571012, -0.4103924876015783, -0.39882704082602877, -0.3097467157670422, -0.22957640746273003, -0.1392477005690455, -0.04983464781560066, 0.017383642633739888, 0.03420626375154147, 0.02211909056260288, -0.0006360974675327503, -0.01622935459295736, -0.02737023898241238, -0.03270721565322424, -0.03649739278011104, -0.039766955153508525, -0.0443742537823932, -0.05541399602793171, -0.0776723898557597, -0.09944544834676522, -0.12014487348876428, -0.1350090802380748, -0.1431098993599373, -0.15250744435947505, -0.16200429855841006, -0.17325619971997938, -0.18531661197563568, -0.20320301767856155, -0.219876220169585, -0.23771812601104428, -0.2554597635216809, -0.266876512365543, -0.26957271497004404, -0.2677886243793105, -0.2597642648495868, -0.2515931378467415, -0.24285902632926284, -0.22377903988421471};
float SS_servo1[] = {0.8177250910102415, 0.8607394519124107, 0.8665740845601405, 0.9324711350160465, 1.0749719560667181, 1.134078105050551, 1.1841964829949199, 1.211123591739862, 1.2091035067237739, 1.1772770446628988, 1.1910696229061701, 1.2283946161088897, 1.2513505093477435, 1.2672098899374236, 1.2810264661572008, 1.2896750270309774, 1.2913580323438485, 1.283801699153356, 1.2580884575875788, 1.217914056279911, 1.1766325055664448, 1.13251060911898, 1.0964100666359633, 1.0814069001503106, 1.0638097940993665, 1.0458901383342667, 1.0365812038255642, 1.02964943121092, 1.0154732794234818, 1.0072109014886659, 1.0013205930107192, 0.9887835005020303, 0.9714781620273836, 0.95650161458725, 0.9333495491446854, 0.9072423920971624, 0.8621745088971348, 0.7946796509044924, 0.7237228624438724};
float SS_servo2[] = {-0.10418775276812202, -0.1631116037142894, -0.21067318640666904, -0.24366686160097162, -0.2586797513324318, -0.2717219727936928, -0.2804686893853878, -0.28562155012442686, -0.2920869652889087, -0.305289037678363, -0.32157328918804057, -0.33639168109629364, -0.3473633987080912, -0.3537816244592052, -0.3545822236057461, -0.3528349436814171, -0.35045280343247875, -0.349367597593135, -0.3582913799910978, -0.3786733756805841, -0.40356201389364943, -0.419146759789948, -0.38993919390878967, -0.3137935649688496, -0.23787127420188892, -0.16059784472934768, -0.08478663402302279, -0.022262721643011872, -0.0026945887900530797, 0.014495949778348446, 0.00723237084311031, -0.020496641966220017, -0.03853679809277924, -0.046728676499702304, -0.0501930705313399, -0.04607253041756269, -0.04361564543229711, -0.04348517482544499, -0.03057797987111596};
float SS_servo3[] = {0.9149855996362204, 0.9688803559772038, 0.9810145427815508, 0.9882303818219728, 1.0086140606046918, 1.024403128879344, 1.0455809164506606, 1.0669854581839389, 1.08713442053856, 1.100432886952215, 1.1157897939982335, 1.1278174753611516, 1.1347240176557798, 1.135715710811591, 1.1365073202287244, 1.1311703042076586, 1.1207277941541136, 1.1034354032593963, 1.079391010013286, 1.0447724463426047, 1.0192429993259178, 0.9782411457721576, 0.9808479563952375, 1.083782161797445, 1.137547902973626, 1.1544785735971237, 1.1634715404917364, 1.1610648275628068, 1.1044933608638108, 1.0566190334687002, 1.0352733517130737, 1.042481220924355, 1.0376049028560308, 1.0307506021124844, 1.0143839987406915, 0.9901027365555225, 0.9487289263800699, 0.8885175715684944, 0.8200513348522591};
float SS_servo4[] = {0.2856904321202193, 0.3203230300711767, 0.31973935422590893, 0.3149960596930715, 0.3188213785324611, 0.3178170961717121, 0.31747719034293187, 0.31844212200528577, 0.31366132174818057, 0.2990887249096613, 0.28034773362205706, 0.2628483171153284, 0.2491487704401178, 0.23847805888444945, 0.231613408872474, 0.22458791085695945, 0.217518376456493, 0.2100770825933747, 0.19613748627903135, 0.1689639081579329, 0.13821304810665738, 0.10630911628558183, 0.08050597856974037, 0.06487154458956225, 0.04596617661448544, 0.02418419742568321, 0.0009652225308430787, -0.026835916874940694, -0.06579152853522341, -0.08590979346195204, -0.07307490033943062, -0.04968309948660624, -0.0017841825207424774, 0.07668015140062162, 0.14928251814266907, 0.23105791481597937, 0.2737956985493837, 0.23719873807685868, 0.18727863297298408};
float SS_servo5[] = {-0.9275288691607992, -1.0275053240531793, -1.102696024991574, -1.1557524216595747, -1.1776059720941476, -1.1878079573761877, -1.1838141311309687, -1.1733237120288447, -1.1553387791285208, -1.1383917699512778, -1.1177267448188593, -1.1009819000615424, -1.0895629270710054, -1.0803766230507696, -1.0680967605651228, -1.055764235182594, -1.0469108162220044, -1.046366263299886, -1.0587539740348164, -1.0797282169532403, -1.0962164415385591, -1.1133459397900722, -1.1252540736799408, -1.124741035074429, -1.1227692479490592, -1.1153659701672167, -1.0997737825610117, -1.0744203687743985, -1.0469655608393376, -1.0446292486930326, -1.0875121521304867, -1.1418495562826643, -1.1674756922338767, -1.115648006397367, -1.0177519738172025, -0.8806117959726553, -0.801910098365174, -0.7961113918062048, -0.7742676718802357};
float SS_servo6[] = {0.07499059510649893, 0.10468041732858095, 0.10188883386881473, 0.09416475802499377, 0.09458117221789122, 0.08997881075163541, 0.08708901462617327, 0.08313587458696133, 0.07425285283448047, 0.05423218239906294, 0.032241185883786244, 0.029802238440820646, 0.0557335272293414, 0.10303914079319723, 0.1790206938355552, 0.2579887110162531, 0.33766341717318227, 0.4156118414066509, 0.46606852347987154, 0.45441202580883855, 0.4326929495730077, 0.4105938765505489, 0.39137569418936924, 0.37949937436005077, 0.36511828129916046, 0.3483370689488392, 0.33007442793653474, 0.3092668454439274, 0.2794873281444428, 0.25093914890200797, 0.224663882265517, 0.19910391770118538, 0.17457449557313584, 0.1524837910622854, 0.1281182868492203, 0.10450505962314235, 0.07502856586179966, 0.032062271018399806, -0.016723209143360708};
float SS_servo7[] = {-1.0256610597084428, -1.1354774850811764, -1.2220860774375717, -1.2784272667654173, -1.2945309115798547, -1.2964122864640752, -1.2814390986381192, -1.2531139487060006, -1.218036061273489, -1.1796925591415832, -1.1433490041140535, -1.1471403855158278, -1.1904890873337464, -1.2207810131005365, -1.1942841652883804, -1.1132050030401628, -1.0032971253803238, -0.9000937275508649, -0.8586582779536607, -0.8923004575561907, -0.9231689380600917, -0.9576542468109411, -0.9814143094096224, -0.9872217679035195, -0.9947245583051842, -0.9992289457886218, -0.9962540091983555, -0.9881523496095528, -0.9830239694622007, -0.9711670450099555, -0.9635386526564954, -0.9626738385333632, -0.9577249924845829, -0.9416629640234055, -0.9228916440653847, -0.9010134638400425, -0.8915816623357775, -0.8856421358916516, -0.8610586871084783};

int node=0;
int first=0;
int input=0;
int end_time=0;
int time_step=150000;
int steps = sizeof(SS_servo0)/sizeof(SS_servo0[0]);

// ------------------------Centers:--------------------------
int centre0=312;
int centre1=293;
int centre2=305;
int centre3=315;
int centre4=315;
int centre5=300;
int centre6=310;
int centre7=315;

// -------------------Joint configurations-------------------
int servo0=0;
int servo0_deg=0;
int servo1=0;
int servo1_deg=0;
int servo2=0;
int servo2_deg=0;
int servo3=0;
int servo3_deg=0;
int servo4=0;
int servo4_deg=0;
int servo5=0;
int servo5_deg=0;
int servo6=0;
int servo6_deg=0;
int servo7=0;
int servo7_deg=0;

void setup() {
  Serial.begin(115200);
  pca9685.begin();

  pca9685.setOscillatorFrequency(27000000); //Value between 24MHz and 27MHz, tuned for this setup
  pca9685.setPWMFreq(SERVO_FREQ);
  delay (500);

  servo0_deg=SS_servo0[0]/3.14159265*180;
  servo0=map(servo0_deg,30,-30,265,355);
  pca9685.setPWM(SER0,0,servo0);

  servo1_deg=SS_servo1[0]/3.14159265*180;
  servo1=map(servo1_deg,30,-30,250,335);
  pca9685.setPWM(SER1,0,servo1);

  servo2_deg=SS_servo2[0]/3.14159265*180;
  servo2=map(servo2_deg,-30,30,265,350);
  pca9685.setPWM(SER2,0,servo2);

  servo3_deg=SS_servo3[0]/3.14159265*180;
  servo3=map(servo3_deg,-30,30,265,360);
  pca9685.setPWM(SER3,0,servo3);

  servo4_deg=SS_servo4[0]/3.14159265*180;
  servo4=map(servo4_deg,30,-30,265,360);
  pca9685.setPWM(SER4,0,servo4);

  servo5_deg=SS_servo5[0]/3.14159265*180;
  servo5=map(servo5_deg,30,-30,250,345);
  pca9685.setPWM(SER5,0,servo5);

  servo6_deg=SS_servo6[0]/3.14159265*180;
  servo6=map(servo6_deg,-30,30,260,355);
  pca9685.setPWM(SER6,0,servo6);

  servo7_deg=SS_servo7[0]/3.14159265*180;
  servo7=map(servo7_deg,-30,30,265,365);
  pca9685.setPWM(SER7,0,servo7);
  
  Serial.println("Ready Steady");
  end_time=esp_timer_get_time()+time_step;
  Serial.println("Hip last entry");
  Serial.println(SS_servo6[steps]);
  Serial.println("Knee last entry");
  Serial.println(SS_servo7[steps]);
  
}

void loop() 
{
  if(Serial.available()>0)
  {
    first=Serial.read();
    if(first=='1')
    {
      input=1;
    }
    if(first=='0')
    {
      input=0;
    }
  }
  if(input==1)
  {
      if(esp_timer_get_time()>=end_time)
      {
        servo0_deg=SS_servo0[node]/3.14159265*180;
        servo0=map(servo0_deg,30,-30,265,355);
        pca9685.setPWM(SER0,0,servo0);

        servo1_deg=SS_servo1[node]/3.14159265*180;
        servo1=map(servo1_deg,30,-30,250,335);
        pca9685.setPWM(SER1,0,servo1);

        servo2_deg=SS_servo2[node]/3.14159265*180;
        servo2=map(servo2_deg,-30,30,265,350);
        pca9685.setPWM(SER2,0,servo2);

        servo3_deg=SS_servo3[node]/3.14159265*180;
        servo3=map(servo3_deg,-30,30,265,360);
        pca9685.setPWM(SER3,0,servo3);

        servo4_deg=SS_servo4[node]/3.14159265*180;
        servo4=map(servo4_deg,30,-30,265,360);
        pca9685.setPWM(SER4,0,servo4);

        servo5_deg=SS_servo5[node]/3.14159265*180;
        servo5=map(servo5_deg,30,-30,250,345);
        pca9685.setPWM(SER5,0,servo5);

        servo6_deg=SS_servo6[node]/3.14159265*180;
        servo6=map(servo6_deg,-30,30,260,355);
        pca9685.setPWM(SER6,0,servo6);

        servo7_deg=SS_servo7[node]/3.14159265*180;
        servo7=map(servo7_deg,-30,30,265,365);
        pca9685.setPWM(SER7,0,servo7);
     
//        Serial.print("Node:");
//        Serial.print(node);
//        Serial.print("       SS_servo0:");
//        Serial.println(SS_servo3[node]);
        node+=1;
        if(node>=steps)
           {
              Serial.print("1 cycle");
              node=0;
            }
         end_time=esp_timer_get_time()+time_step;
      }
   }

  if(input == 0)
  {
   servo0_deg=SS_servo0[node]/3.14159265*180;
   servo0=map(servo0_deg,30,-30,265,355);
   pca9685.setPWM(SER0,0,servo0);

   servo1_deg=SS_servo1[node]/3.14159265*180;
   servo1=map(servo1_deg,30,-30,250,335);
   pca9685.setPWM(SER1,0,servo1);

   servo2_deg=SS_servo2[node]/3.14159265*180;
   servo2=map(servo2_deg,-30,30,265,350);
   pca9685.setPWM(SER2,0,servo2);

   servo3_deg=SS_servo3[node]/3.14159265*180;
   servo3=map(servo3_deg,-30,30,265,360);
   pca9685.setPWM(SER3,0,servo3);

   servo4_deg=SS_servo4[node]/3.14159265*180;
   servo4=map(servo4_deg,30,-30,265,360);
   pca9685.setPWM(SER4,0,servo4);
 
   servo5_deg=SS_servo5[node]/3.14159265*180;
   servo5=map(servo5_deg,30,-30,250,345);
   pca9685.setPWM(SER5,0,servo5);

   servo6_deg=SS_servo6[node]/3.14159265*180;
   servo6=map(servo6_deg,-30,30,260,355);
   pca9685.setPWM(SER6,0,servo6);

   servo7_deg=SS_servo7[node]/3.14159265*180;
   servo7=map(servo7_deg,-30,30,265,365);
   pca9685.setPWM(SER7,0,servo7);
  
  }
}
