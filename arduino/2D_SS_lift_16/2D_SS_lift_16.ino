// HOW TO:
// ------------------------------
// Serial input = 2 -> Steps through gait sequence once and stops at the end.
// Serial input = 1 -> Steps through gait sequence in a loop.
// Serial input = 0 -> Stops infinite loop at the node where it is at that moment

//Gait template
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pca9685 = Adafruit_PWMServoDriver();

#define SERVO_FREQ 300
#define SER0 0 //Hip 1
#define SER1 1 //Knee 1
#define SER2 2 //Hip 2
#define SER3 3 //Knee 2
#define SER4 4 //Hip 3
#define SER5 5 //Knee 3
#define SER6 6 //Hip 4
#define SER7 7 //Knee 4

// Insert servo angles here:
// For 3D gaits, these angles are obtained from linearisation.py
// For 2D gaits, these angles are obtained from 2D_trajectory_reader.py
float SS_servo0[] = {-0.21394105, -0.2243847 , -0.23998644, -0.25630309, -0.2718725 , -0.28134917, -0.29082584, -0.29554587, -0.29695638, -0.29075371, -0.27497137, -0.24830637, -0.21830632, -0.18575491, -0.1532035 , -0.12019499, -0.08464963, -0.04910426, -0.01516502,  0.00517061,  0.0074588 ,  0.00360927, -0.00059034, -0.00545528, -0.00955687, -0.00962581, -0.01047416, -0.01284049, -0.01520682, -0.01842242, -0.02488066, -0.03133889, -0.03943972, -0.04902835, -0.05916416, -0.07003607, -0.08069109, -0.09160669, -0.10271964, -0.11323127, -0.12264533, -0.13056788, -0.12812164, -0.11857419, -0.10386568, -0.09308423, -0.09282261, -0.09256099, -0.09272602, -0.09295004, -0.09317406, -0.09339807, -0.09362209, -0.09384611, -0.09407013, -0.0962451 , -0.10405726, -0.11186942, -0.11968158, -0.12749374, -0.1353059 , -0.14399131, -0.14625599, -0.15161108, -0.15479203, -0.16382997, -0.17694615, -0.19868328, -0.22323232, -0.24092433, -0.24503789, -0.24043245, -0.23359951, -0.22696037, -0.22063963, -0.21457261, -0.20844214, -0.20142473, -0.19433156, -0.18827518, -0.1834878 , -0.1818624 , -0.1832608 , -0.18465375, -0.1860467 , -0.18743964, -0.18883182, -0.19022399, -0.19164669, -0.19534758, -0.20258036};
float SS_servo1[] = {0.12050142, 0.1684019 , 0.25113361, 0.3360084 , 0.42871677, 0.50357603, 0.57843529, 0.63903874, 0.68972343, 0.71899192, 0.71570964, 0.67370898, 0.6159894 , 0.54532125, 0.4746531 , 0.40234638, 0.32094579, 0.23954521, 0.16524161, 0.11783067, 0.10049913, 0.09919223, 0.09834294, 0.10071274, 0.10023122, 0.09390737, 0.08856933, 0.08674885, 0.08492837, 0.08497291, 0.09213833, 0.09930375, 0.10793919, 0.11888353, 0.13210818, 0.14626497, 0.15960081, 0.17185748, 0.18327196, 0.19094098, 0.19551771, 0.19208921, 0.17970313, 0.15147412, 0.11522023, 0.0901074 , 0.08437626, 0.07864511, 0.07365131, 0.06875946, 0.0638676 , 0.05897574, 0.05408388, 0.04919202, 0.04430017, 0.04330079, 0.0535486 , 0.0637964 , 0.07404421, 0.08429201, 0.09453982, 0.10762662, 0.10924595, 0.1133902 , 0.11627664, 0.1291913 , 0.15126276, 0.18832102, 0.23349288, 0.26646503, 0.26513846, 0.24916664, 0.23128129, 0.21269012, 0.19732675, 0.18228781, 0.16720318, 0.15148011, 0.13517252, 0.12032249, 0.10997527, 0.10543805, 0.10430559, 0.10455082, 0.10479605, 0.10503139, 0.10443614, 0.10384089, 0.10236863, 0.1026159 , 0.10487474};
float SS_servo2[] = { 0.05206727,  0.05437881,  0.05357343,  0.04837517,  0.04247011,  0.03490167,  0.02733324,  0.01850729,  0.0088064 ,  0.00242369, -0.004087  , -0.00854832, -0.0112321 , -0.01743458, -0.02363707, -0.03123216, -0.04655609, -0.06188002, -0.07826283, -0.0886272 , -0.0920239 , -0.08983398, -0.08595267, -0.07973152, -0.07628331, -0.07786242, -0.08071682, -0.08355869, -0.08640057, -0.08926604, -0.09222165, -0.09517726, -0.09882364, -0.10268026, -0.10616596, -0.10928522, -0.1130642 , -0.11819163, -0.12396908, -0.13144336, -0.13608012, -0.14150704, -0.14477498, -0.15167102, -0.15647251, -0.15718946, -0.15974529, -0.16230113, -0.16586295, -0.16956384, -0.17326473, -0.17696563, -0.18066652, -0.18436741, -0.18806831, -0.19026762, -0.18812818, -0.18598873, -0.18384929, -0.18170985, -0.1795704 , -0.16999256, -0.1475433 , -0.11547784, -0.07750508, -0.03710479,  0.00294332,  0.04071855,  0.07671932,  0.10805891,  0.11432554,  0.11323525,  0.11079919,  0.10851285,  0.10750349,  0.10606518,  0.10456542,  0.10220697,  0.09969259,  0.09766179,  0.09718669,  0.09849366,  0.09921374,  0.09832237,  0.097431  ,  0.09649231,  0.09157866,  0.08666502,  0.08055138,  0.07222219,  0.06080184};
float SS_servo3[] = {0.13749514, 0.11767647, 0.1012076 , 0.09285941, 0.08793622, 0.08716098, 0.08638573, 0.08902009, 0.09402673, 0.09482599, 0.09548728, 0.09292483, 0.08877955, 0.09103903, 0.0932985 , 0.09836341, 0.11899814, 0.13963288, 0.1648385 , 0.17780312, 0.17164996, 0.15849071, 0.1418113 , 0.12248404, 0.10722405, 0.10386505, 0.10247135, 0.10160444, 0.10073753, 0.10011516, 0.10042646, 0.10073776, 0.10065358, 0.10037652, 0.10057509, 0.09954552, 0.0993899 , 0.10029012, 0.10123755, 0.10294638, 0.09815244, 0.08981952, 0.0885793 , 0.09241846, 0.09430747, 0.09413022, 0.10229167, 0.11045313, 0.14598145, 0.18529333, 0.22460522, 0.26391711, 0.303229  , 0.34254089, 0.38185277, 0.42248887, 0.46695123, 0.51141358, 0.55587593, 0.60033829, 0.64480064, 0.67032609, 0.65404459, 0.59706711, 0.52168138, 0.43356722, 0.34944605, 0.26899927, 0.19520389, 0.13162222, 0.1097874 , 0.10470082, 0.10469804, 0.10333183, 0.10211604, 0.10158314, 0.10125268, 0.10375161, 0.10611591, 0.10701855, 0.10693318, 0.10297336, 0.09765465, 0.09693605, 0.09621746, 0.09558225, 0.10195083, 0.10831941, 0.11611904, 0.12556884, 0.13624584};
float SS_servo4[] = { 0.27153933,  0.25589156,  0.23978343,  0.22545726,  0.21379773,  0.20425567,  0.19471362,  0.187138  ,  0.18093058,  0.17451952,  0.16824494,  0.16146049,  0.15468398,  0.15003655,  0.14538911,  0.14141663,  0.14119007,  0.14096351,  0.14285916,  0.14399706,  0.14053696,  0.13154744,  0.11810738,  0.10942383,  0.10056653,  0.09471314,  0.08895197,  0.08482505,  0.08069813,  0.07736479,  0.07706145,  0.07675812,  0.07423021,  0.06962693,  0.06683753,  0.0666617 ,  0.07097334,  0.08047455,  0.09552065,  0.12009844,  0.14451545,  0.16115554,  0.16611655,  0.15690568,  0.14447239,  0.13266562,  0.12093609,  0.10920657,  0.10250248,  0.09649317,  0.09048386,  0.08447455,  0.07846525,  0.07245594,  0.06644663,  0.06001518,  0.05236396,  0.04471274,  0.03706152,  0.0294103 ,  0.02175908,  0.01196902,  0.00269487, -0.00675384, -0.01402678, -0.02093471, -0.02689988, -0.03333923, -0.04079522, -0.04882249, -0.05278049, -0.04339158, -0.01632095,  0.01996657,  0.06174385,  0.10460496,  0.14747087,  0.19040387,  0.23292707,  0.26489731,  0.28837944,  0.30122268,  0.30711233,  0.30511659,  0.30312086,  0.30102446,  0.29047409,  0.27992373,  0.26930183,  0.2625189 ,  0.26570886};
float SS_servo5[] = {-0.15259311, -0.13746126, -0.12417484, -0.11487005, -0.10871859, -0.10576806, -0.10281753, -0.10274496, -0.10467481, -0.10389584, -0.10375666, -0.1018362 , -0.09802606, -0.0988335 , -0.09964094, -0.10168629, -0.11060192, -0.11951754, -0.13007534, -0.13958539, -0.14555842, -0.13685337, -0.11970191, -0.1099028 , -0.10111627, -0.0960803 , -0.09178489, -0.0901893 , -0.08859371, -0.08835197, -0.09327942, -0.09820687, -0.10047075, -0.09929065, -0.10045553, -0.10723541, -0.12322169, -0.15095354, -0.1907736 , -0.2518229 , -0.31363249, -0.36544895, -0.38286672, -0.37445713, -0.35765257, -0.33854807, -0.32080145, -0.30305484, -0.29523122, -0.28877948, -0.28232775, -0.27587602, -0.26942429, -0.26297256, -0.25652083, -0.24914289, -0.23908869, -0.22903449, -0.21898029, -0.20892609, -0.19887189, -0.18341473, -0.16792702, -0.15563148, -0.14461905, -0.13570526, -0.12740565, -0.11990624, -0.10750924, -0.09282066, -0.094373  , -0.12039283, -0.17952378, -0.2568331 , -0.34195834, -0.42932254, -0.516157  , -0.59558785, -0.67384035, -0.71405724, -0.72233606, -0.69567805, -0.65117597, -0.57986615, -0.50855634, -0.43706517, -0.35034374, -0.26362231, -0.18330623, -0.12770475, -0.12531799};
float SS_servo6[] = { 0.256529  ,  0.24646895,  0.22886817,  0.20829444,  0.18836038,  0.17113773,  0.15391508,  0.13771428,  0.12222446,  0.10733267,  0.09191923,  0.07614926,  0.06182606,  0.04861833,  0.03541059,  0.02205516,  0.00788004, -0.00629509, -0.01961976, -0.02790682, -0.03119862, -0.01794254,  0.00510045,  0.03633654,  0.07300018,  0.11320206,  0.1502496 ,  0.18386129,  0.21747298,  0.24898486,  0.27247945,  0.29597403,  0.31407445,  0.32367178,  0.32520531,  0.32042066,  0.31120782,  0.29885772,  0.28405568,  0.2652824 ,  0.24151038,  0.21882248,  0.21514494,  0.21290114,  0.20926372,  0.20553315,  0.20120494,  0.19687674,  0.19287018,  0.1889081 ,  0.18494601,  0.18098393,  0.17702185,  0.17305976,  0.16909768,  0.16597851,  0.16529489,  0.16461128,  0.16392767,  0.16324406,  0.16256045,  0.16305896,  0.16165671,  0.15948708,  0.15807631,  0.15737455,  0.15902152,  0.16104204,  0.16997591,  0.17882078,  0.18186762,  0.17537183,  0.16001003,  0.14258201,  0.13346734,  0.12625212,  0.11957089,  0.12035271,  0.12072213,  0.11956321,  0.11894523,  0.11593443,  0.11215311,  0.11381093,  0.11546874,  0.1172705 ,  0.13116094,  0.14505138,  0.16414598,  0.19652591,  0.23258359};
float SS_servo7[] = {-0.42063569, -0.41631061, -0.40010437, -0.37861703, -0.35624323, -0.33827024, -0.32029726, -0.30335353, -0.28712593, -0.26970122, -0.25160544, -0.23200201, -0.21331399, -0.19727822, -0.18124245, -0.16483837, -0.14639023, -0.12794209, -0.10869151, -0.09979258, -0.10618507, -0.14134565, -0.19636464, -0.26594543, -0.34771707, -0.43345204, -0.50639256, -0.56536411, -0.62433566, -0.67525634, -0.69543783, -0.71561931, -0.71915993, -0.69584121, -0.64617373, -0.58015244, -0.50181499, -0.41995098, -0.33715276, -0.25514213, -0.16374082, -0.10424846, -0.10477566, -0.11003535, -0.11052859, -0.10735038, -0.10420625, -0.10106212, -0.09859222, -0.09621555, -0.09383887, -0.09146219, -0.08908551, -0.08670883, -0.08433215, -0.08350519, -0.08715608, -0.09080696, -0.09445784, -0.09810873, -0.10175961, -0.10652284, -0.10654318, -0.10858231, -0.10909851, -0.11238844, -0.1190136 , -0.12808736, -0.14781633, -0.16621814, -0.18133981, -0.17578846, -0.15056862, -0.12232318, -0.10770375, -0.09698019, -0.08721904, -0.09090829, -0.09421318, -0.09502779, -0.09488296, -0.09035413, -0.08676268, -0.09249256, -0.09822244, -0.10424288, -0.13466563, -0.16508839, -0.20655432, -0.27646087, -0.35826429};

int node=0;
int first=0;
int input=0;
int end_time=0;
int time_step=150000;
int steps = sizeof(SS_servo0)/sizeof(SS_servo0[0]);
int one_print = 0;

// -------------------Joint configurations-------------------
int servo0=0;
int servo0_deg=0;
int servo1=0;
int servo1_deg=0;
int servo2=0;
int servo2_deg=0;
int servo3=0;
int servo3_deg=0;
int servo4=0;
int servo4_deg=0;
int servo5=0;
int servo5_deg=0;
int servo6=0;
int servo6_deg=0;
int servo7=0;
int servo7_deg=0;

void setup() {
  Serial.begin(115200);
  pca9685.begin();

  pca9685.setOscillatorFrequency(27000000); //Value between 24MHz and 27MHz, tuned for this setup
  pca9685.setPWMFreq(SERVO_FREQ);
  delay (1000);

  servo0_deg=SS_servo0[0]/3.14159265*180;
        servo0=map(servo0_deg,-38,90,2200,1030);
        servo1_deg=SS_servo1[0]/3.14159265*180;
        servo1=map(servo1_deg,-90,90,2600,950);
        servo2_deg=SS_servo2[0]/3.14159265*180;
        servo2=map(servo2_deg,-37,90,1500,2670);
        servo3_deg=SS_servo3[0]/3.14159265*180;
        servo3=map(servo3_deg,-90,90,1100,2700);
        servo4_deg=SS_servo4[0]/3.14159265*180;
        servo4=map(servo4_deg,-90,38,2700,1500);
        servo5_deg=SS_servo5[0]/3.14159265*180;
        servo5=map(servo5_deg,-90,90,2600,930);
        servo6_deg=SS_servo6[0]/3.14159265*180;
        servo6=map(servo6_deg,-90,38,850,2250);
        servo7_deg=SS_servo7[0]/3.14159265*180;
        servo7=map(servo7_deg,-90,90,920,2620);
        
        pca9685.setPWM(SER0,0,servo0);
        pca9685.setPWM(SER1,0,servo1);
        pca9685.setPWM(SER2,0,servo2);
        pca9685.setPWM(SER3,0,servo3);
        pca9685.setPWM(SER4,0,servo4);
        pca9685.setPWM(SER5,0,servo5);
        pca9685.setPWM(SER6,0,servo6);
        pca9685.setPWM(SER7,0,servo7);

        Serial.print("Node:");
        Serial.println(node);
        Serial.print("servo0 -> rads:");
        Serial.print(SS_servo0[node]);
        Serial.print("        deg:");
        Serial.print(servo0_deg);
        Serial.print("        us:");
        Serial.println(servo0);
        Serial.print("servo1 -> rads:");
        Serial.print(SS_servo1[node]);
        Serial.print("        deg:");
        Serial.print(servo1_deg);
        Serial.print("        us:");
        Serial.println(servo1);
        Serial.print("servo2 -> rads:");
        Serial.print(SS_servo2[node]);
        Serial.print("        deg:");
        Serial.print(servo2_deg);
        Serial.print("        us:");
        Serial.println(servo2);
        Serial.print("servo3 -> rads:");
        Serial.print(SS_servo3[node]);
        Serial.print("        deg:");
        Serial.print(servo3_deg);
        Serial.print("        us:");
        Serial.println(servo3);
        Serial.print("servo4 -> rads:");
        Serial.print(SS_servo4[node]);
        Serial.print("        deg:");
        Serial.print(servo4_deg);
        Serial.print("        us:");
        Serial.println(servo4);
        Serial.print("servo5 -> rads:");
        Serial.print(SS_servo5[node]);
        Serial.print("        deg:");
        Serial.print(servo5_deg);
        Serial.print("        us:");
        Serial.println(servo5);
        Serial.print("servo6 -> rads:");
        Serial.print(SS_servo6[node]);
        Serial.print("        deg:");
        Serial.print(servo6_deg);
        Serial.print("        us:");
        Serial.println(servo6);
        Serial.print("servo7 -> rads:");
        Serial.print(SS_servo7[node]);
        Serial.print("        deg:");
        Serial.print(servo7_deg);
        Serial.print("        us:");
        Serial.println(servo7);

        Serial.println("10");
        delay(1000);
        Serial.println("9");
        delay(1000);
        Serial.println("8");
        delay(1000);
        Serial.println("7");
        delay(1000);
        Serial.println("6");
        delay(1000);
        Serial.println("5");
        delay(1000);
        Serial.println("4");
        delay(1000);
        Serial.println("3");
        delay(1000);
        Serial.println("2");
        delay(1000);
        Serial.println("1");
        delay(1000);

}

void loop() 
{
  if(Serial.available()>0)
  {
    first=Serial.read();
    if(first=='2')
    {
      input=2;
      node=0;
      one_print=1;
    }
    if(first=='1')
    {
      input=1;
      node=0;
      one_print=1;
    }
    if(first=='0')
    {
      input=0;
    }
  }
  if(input==1 or input==2)
  {
      if(esp_timer_get_time()>=end_time)
      {
        servo0_deg=SS_servo0[node]/3.14159265*180;
        servo0=map(servo0_deg,-38,90,2200,1030);
        servo1_deg=SS_servo1[node]/3.14159265*180;
        servo1=map(servo1_deg,-90,90,2600,950);
        servo2_deg=SS_servo2[node]/3.14159265*180;
        servo2=map(servo2_deg,-37,90,1500,2670);
        servo3_deg=SS_servo3[node]/3.14159265*180;
        servo3=map(servo3_deg,-90,90,1100,2700);
        servo4_deg=SS_servo4[node]/3.14159265*180;
        servo4=map(servo4_deg,-90,38,2700,1500);
        servo5_deg=SS_servo5[node]/3.14159265*180;
        servo5=map(servo5_deg,-90,90,2600,930);
        servo6_deg=SS_servo6[node]/3.14159265*180;
        servo6=map(servo6_deg,-90,38,850,2250);
        servo7_deg=SS_servo7[node]/3.14159265*180;
        servo7=map(servo7_deg,-90,90,920,2620);
        
        pca9685.setPWM(SER0,0,servo0);
        pca9685.setPWM(SER1,0,servo1);
        pca9685.setPWM(SER2,0,servo2);
        pca9685.setPWM(SER3,0,servo3);
        pca9685.setPWM(SER4,0,servo4);
        pca9685.setPWM(SER5,0,servo5);
        pca9685.setPWM(SER6,0,servo6);
        pca9685.setPWM(SER7,0,servo7);
        
        node+=1;
        if(node>=steps and input==1)
        {
          Serial.print("Input:");
          Serial.println(input);
          node=0;
        }
        if(node>=steps and input==2)
        {
          Serial.print("Input:");
          Serial.println(input);
          input=0;
        }
         end_time=esp_timer_get_time()+time_step;
      }
   }

  if(input == 0)
  {        
        pca9685.setPWM(SER0,0,servo0);
        pca9685.setPWM(SER1,0,servo1);
        pca9685.setPWM(SER2,0,servo2);
        pca9685.setPWM(SER3,0,servo3);
        pca9685.setPWM(SER4,0,servo4);
        pca9685.setPWM(SER5,0,servo5);
        pca9685.setPWM(SER6,0,servo6);
        pca9685.setPWM(SER7,0,servo7);

        if(one_print==1)
        {
          Serial.print("Input:");
          Serial.println(input);
          Serial.print("Node:");
          Serial.println(node);
          Serial.print("servo0 -> rads:");
          Serial.print(SS_servo0[node]);
          Serial.print("        deg:");
          Serial.print(servo0_deg);
          Serial.print("        us:");
          Serial.println(servo0);
          Serial.print("servo1 -> rads:");
          Serial.print(SS_servo1[node]);
          Serial.print("        deg:");
          Serial.print(servo1_deg);
          Serial.print("        us:");
          Serial.println(servo1);
          Serial.print("servo2 -> rads:");
          Serial.print(SS_servo2[node]);
          Serial.print("        deg:");
          Serial.print(servo2_deg);
          Serial.print("        us:");
          Serial.println(servo2);
          Serial.print("servo3 -> rads:");
          Serial.print(SS_servo3[node]);
          Serial.print("        deg:");
          Serial.print(servo3_deg);
          Serial.print("        us:");
          Serial.println(servo3);
          Serial.print("servo4 -> rads:");
          Serial.print(SS_servo4[node]);
          Serial.print("        deg:");
          Serial.print(servo4_deg);
          Serial.print("        us:");
          Serial.println(servo4);
          Serial.print("servo5 -> rads:");
          Serial.print(SS_servo5[node]);
          Serial.print("        deg:");
          Serial.print(servo5_deg);
          Serial.print("        us:");
          Serial.println(servo5);
          Serial.print("servo6 -> rads:");
          Serial.print(SS_servo6[node]);
          Serial.print("        deg:");
          Serial.print(servo6_deg);
          Serial.print("        us:");
          Serial.println(servo6);
          Serial.print("servo7 -> rads:");
          Serial.print(SS_servo7[node]);
          Serial.print("        deg:");
          Serial.print(servo7_deg);
          Serial.print("        us:");
          Serial.println(servo7);
          one_print=0;
        }
  
  }
}
