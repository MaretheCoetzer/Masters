//Gait template
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pca9685 = Adafruit_PWMServoDriver();

#define SERVO_FREQ 50
#define SER0 0 //Hip 1
#define SER1 1 //Knee 1
#define SER2 2 //Hip 2
#define SER3 3 //Knee 2
#define SER4 4 //Hip 3
#define SER5 5 //Knee 3
#define SER6 6 //Hip 4
#define SER7 7 //Knee 4

float SS_servo0[] = {-0.42556418116762934, -0.49327414642680334, -0.49615498127580254, -0.42329659231723404, -0.34596235829888583, -0.25276188711771685, -0.16891282044533257, -0.06905559001019329, 0.02706630088092256, 0.09964362784122138, 0.10252764634397143, 0.07568156612954847, 0.05500190159325845, 0.04270967889658785, 0.03160335026768221, 0.021023722903642718, 0.010304897958851379, -0.0015161141659263576, -0.014428573240778887, -0.027870374446730403, -0.044830465393916115, -0.06369566766602254, -0.08386644191989936, -0.1048809303326706, -0.1265351828625495, -0.14960809064424305, -0.17380274383273842, -0.20227006927168806, -0.2329012869157908, -0.2626779011990347, -0.28928285215131905, -0.31084544970464767, -0.33238271240286915, -0.3504674649725901, -0.3640667219634204, -0.368000197289291, -0.3626220078843122, -0.35878995507231837, -0.3418526449279306};
float SS_servo1[] = {0.6828776574803064, 0.6881293895615131, 0.7317457935474612, 0.8905844915065422, 1.0066654272803275, 1.039084720376314, 1.0485509403451323, 1.0748274791239742, 1.0977794920770638, 1.1085474436771106, 1.1037312731503066, 1.1474146499790354, 1.1812221071641495, 1.2055144269503144, 1.2217151822543155, 1.229764002484235, 1.2309193910568033, 1.2240003141662505, 1.2075274735429444, 1.183199681246591, 1.1621591792896226, 1.1369462153076066, 1.1175574428471164, 1.0985226643478334, 1.0819806703417292, 1.0686514235134565, 1.062338282461809, 1.0507594963596258, 1.0304954904452988, 1.0154322991673146, 1.006965700335865, 1.0019828279394483, 0.9776072447493066, 0.9442666968642781, 0.8970778787355125, 0.8531128375089687, 0.7953558230553001, 0.7175626947853778, 0.6389724183100836};
float SS_servo2[] = {-0.12776768197915256, -0.20264544057259318, -0.25823942181716464, -0.2950245144128229, -0.3220516191466051, -0.34428070083035356, -0.361556800585438, -0.3757456944864018, -0.38646098840295706, -0.39772786732450216, -0.41325338858220806, -0.4296265147875676, -0.44009779037786867, -0.4451559942592431, -0.4484547204337481, -0.45185685090476135, -0.45513134671589833, -0.4599068749308488, -0.4651366869278902, -0.4359600544977051, -0.3616923580780228, -0.2924171851495627, -0.21846015556866447, -0.14602798314039417, -0.07205709525374801, -0.001495044766696929, 0.06841835698584542, 0.10796003633936667, 0.1173968520624427, 0.12280311366612906, 0.10473412232366336, 0.07012456717254091, 0.036497897977321156, 0.006861414010827728, -0.019758571300694944, -0.0348176747236411, -0.0410774962085661, -0.051979896308133065, -0.04567433141535136};
float SS_servo3[] = {0.835217161913288, 0.8551094364544823, 0.8488248146960335, 0.852068125643927, 0.858886029113477, 0.8740001196133911, 0.8902564215931574, 0.9180821128379254, 0.9462037419508285, 0.9738355832048545, 0.9904744843855909, 1.0044553963659582, 1.0100406493157974, 1.0132598361850325, 1.009237177875199, 1.000157501151337, 0.9860402518844578, 0.966902887919269, 0.9405143829113698, 0.9588355085171731, 1.0541576821478797, 1.1126436880718287, 1.1661300122841087, 1.1961447525020565, 1.2080489625922552, 1.2049517373662815, 1.2056462483376664, 1.175151405316994, 1.1074545975157983, 1.0516574483869454, 1.0329205220120332, 1.051384514898409, 1.0486969532418418, 1.033412319361605, 1.0042104741292348, 0.9710840217971752, 0.9214369663562652, 0.8549707974290478, 0.7789476876162019};
float SS_servo4[] = {0.42574758343705865, 0.43654457209796915, 0.4235422184570061, 0.4143126374009594, 0.40420943053259306, 0.3918084104018503, 0.3803113487575302, 0.37240099993508063, 0.36619576835976014, 0.35443896242221573, 0.3369212812237166, 0.3184342308339507, 0.3032680891354702, 0.29082794741117113, 0.277830804497601, 0.26293211929111787, 0.24711983218885014, 0.23040349735802484, 0.21401630789245854, 0.19904586841912222, 0.18080117808232762, 0.1585871354727131, 0.13522057077068805, 0.11011545416216376, 0.08320386573893229, 0.05357206676919947, 0.02158008660663347, -0.022998082677104112, -0.058746312218677606, -0.049241438795690776, 0.006421916118995041, 0.09938695239861188, 0.1746816406177367, 0.2546837018141748, 0.3190964547426789, 0.3900485711045445, 0.43156879369146817, 0.38624344638442526, 0.3469525905993498};
float SS_servo5[] = {-0.8847250060019873, -0.9934718918637985, -1.074990189871103, -1.1250817309954368, -1.1537258030458515, -1.1587388332326365, -1.1523245296754294, -1.1304369355188697, -1.1035778454829224, -1.0707731856952871, -1.0493654758802493, -1.0298826796099432, -1.0137064107955989, -0.9956443469165873, -0.9809664859660031, -0.9679916072313813, -0.9584980263355423, -0.9549474599094512, -0.9608031524397826, -0.9761017855943678, -0.9897563248218433, -1.0037658176954818, -1.0136543333105799, -1.0221108012501297, -1.026532996830561, -1.0257561366217387, -1.016121277711538, -0.9967038438615488, -1.0035424475149215, -1.0706298404445365, -1.1020614769942574, -1.0791449865928668, -1.0795352732750485, -1.0749556116256744, -1.046069003187611, -0.893933634856137, -0.7579180243710739, -0.7507553462256271, -0.7362285294433991};
float SS_servo6[] = {0.012738932143274598, 0.01385226225603741, -0.008294372705921038, -0.02693282908291766, -0.04523096941773867, -0.061618509045737284, -0.07781863429639554, -0.09193549743151759, -0.10701897502512452, -0.11035699363790273, -0.0922710510469643, -0.060098579957342343, -0.010719806537998413, 0.0655158343979277, 0.14583026690507103, 0.2242239113898031, 0.3028551950370353, 0.3784146647598375, 0.4548034471666271, 0.5057719736415153, 0.49942849476832324, 0.48366138541742715, 0.4683143941780985, 0.4514965514921285, 0.43355919791161684, 0.41342980085311193, 0.3913599742430212, 0.36134983679530264, 0.3261205126668812, 0.29323928522827225, 0.25933741312606584, 0.22769574690821387, 0.19356927980639962, 0.16458275935781336, 0.13195900815735725, 0.09772657453014666, 0.060784503867398074, 0.004542153939917344, -0.05353191095610014};
float SS_servo7[] = {-1.0650080742447972, -1.1912158153197898, -1.2804397736534932, -1.327759746340019, -1.3456110709391815, -1.3365474214319948, -1.3085309291608502, -1.2587519277672379, -1.2006227808599599, -1.1693536490262004, -1.1907617172298517, -1.2320173859064938, -1.2595894658172395, -1.2508511104342843, -1.2128693472368364, -1.13496918367936, -1.025555601196488, -0.8996755712826733, -0.7752748354227215, -0.7147431934778067, -0.7355899864535683, -0.759788098705321, -0.7824672209644206, -0.8047938045658499, -0.8249932175088452, -0.8420445310272254, -0.8519603673946109, -0.8619555436202653, -0.875543610328563, -0.886363199720118, -0.8843525637029997, -0.8750228108331556, -0.8771935935890548, -0.8910234712579026, -0.9060473149360119, -0.9042184568310465, -0.9055269436205399, -0.904926070771922, -0.8858410700785749};

int node=0;
int first=0;
int input=0;
int end_time=0;
int time_step=50000;
int steps = sizeof(SS_servo0)/sizeof(SS_servo0[0]);

// ------------------------Centers:--------------------------
int centre0=312;
int centre1=293;
int centre2=305;
int centre3=315;
int centre4=315;
int centre5=300;
int centre6=310;
int centre7=315;

// -------------------Joint configurations-------------------
int servo0=0;
int servo0_deg=0;
int servo1=0;
int servo1_deg=0;
int servo2=0;
int servo2_deg=0;
int servo3=0;
int servo3_deg=0;
int servo4=0;
int servo4_deg=0;
int servo5=0;
int servo5_deg=0;
int servo6=0;
int servo6_deg=0;
int servo7=0;
int servo7_deg=0;

void setup() {
  Serial.begin(115200);
  pca9685.begin();

  pca9685.setOscillatorFrequency(27000000); //Value between 24MHz and 27MHz, tuned for this setup
  pca9685.setPWMFreq(SERVO_FREQ);
  delay (500);

  servo0_deg=SS_servo0[0]/3.14159265*180;
  servo0=map(servo0_deg,30,-30,265,355);
  pca9685.setPWM(SER0,0,servo0);

  servo1_deg=SS_servo1[0]/3.14159265*180;
  servo1=map(servo1_deg,30,-30,250,335);
  pca9685.setPWM(SER1,0,servo1);

  servo2_deg=SS_servo2[0]/3.14159265*180;
  servo2=map(servo2_deg,-30,30,265,350);
  pca9685.setPWM(SER2,0,servo2);

  servo3_deg=SS_servo3[0]/3.14159265*180;
  servo3=map(servo3_deg,-30,30,265,360);
  pca9685.setPWM(SER3,0,servo3);

  servo4_deg=SS_servo4[0]/3.14159265*180;
  servo4=map(servo4_deg,30,-30,265,360);
  pca9685.setPWM(SER4,0,servo4);

  servo5_deg=SS_servo5[0]/3.14159265*180;
  servo5=map(servo5_deg,30,-30,250,345);
  pca9685.setPWM(SER5,0,servo5);

  servo6_deg=SS_servo6[0]/3.14159265*180;
  servo6=map(servo6_deg,-30,30,260,355);
  pca9685.setPWM(SER6,0,servo6);

  servo7_deg=SS_servo7[0]/3.14159265*180;
  servo7=map(servo7_deg,-30,30,265,365);
  pca9685.setPWM(SER7,0,servo7);
  
  Serial.println("Ready Steady");
  end_time=esp_timer_get_time()+time_step;
  Serial.println(steps);
  Serial.println("Hip first entry");
  Serial.println(SS_servo6[0]);
  Serial.println("Knee first entry");
  Serial.println(SS_servo7[0]);
  Serial.println("Hip last entry");
  Serial.println(SS_servo6[steps]);
  Serial.println("Knee last entry");
  Serial.println(SS_servo7[steps]);
  
}

void loop() 
{
  if(Serial.available()>0)
  {
    first=Serial.read();
    if(first=='1')
    {
      input=1;
    }
    if(first=='0')
    {
      input=0;
    }
  }
  if(input==1)
  {
      if(esp_timer_get_time()>=end_time)
      {
        servo0_deg=SS_servo0[node]/3.14159265*180;
        servo0=map(servo0_deg,30,-30,265,355);
        pca9685.setPWM(SER0,0,servo0);

        servo1_deg=SS_servo1[node]/3.14159265*180;
        servo1=map(servo1_deg,30,-30,250,335);
        pca9685.setPWM(SER1,0,servo1);

        servo2_deg=SS_servo2[node]/3.14159265*180;
        servo2=map(servo2_deg,-30,30,265,350);
        pca9685.setPWM(SER2,0,servo2);

        servo3_deg=SS_servo3[node]/3.14159265*180;
        servo3=map(servo3_deg,-30,30,265,360);
        pca9685.setPWM(SER3,0,servo3);

        servo4_deg=SS_servo4[node]/3.14159265*180;
        servo4=map(servo4_deg,30,-30,265,360);
        pca9685.setPWM(SER4,0,servo4);

        servo5_deg=SS_servo5[node]/3.14159265*180;
        servo5=map(servo5_deg,30,-30,250,345);
        pca9685.setPWM(SER5,0,servo5);

        servo6_deg=SS_servo6[node]/3.14159265*180;
        servo6=map(servo6_deg,-30,30,260,355);
        pca9685.setPWM(SER6,0,servo6);

        servo7_deg=SS_servo7[node]/3.14159265*180;
        servo7=map(servo7_deg,-30,30,265,365);
        pca9685.setPWM(SER7,0,servo7);
     
//        Serial.print("Node:");
//        Serial.print(node);
//        Serial.print("       SS_servo0:");
//        Serial.println(SS_servo3[node]);
        node+=1;
        if(node>=steps)
           {
              Serial.print("1 cycle");
              node=0;
            }
         end_time=esp_timer_get_time()+time_step;
      }
   }

  if(input == 0)
  {
   servo0_deg=SS_servo0[node]/3.14159265*180;
   servo0=map(servo0_deg,30,-30,265,355);
   pca9685.setPWM(SER0,0,servo0);

   servo1_deg=SS_servo1[node]/3.14159265*180;
   servo1=map(servo1_deg,30,-30,250,335);
   pca9685.setPWM(SER1,0,servo1);

   servo2_deg=SS_servo2[node]/3.14159265*180;
   servo2=map(servo2_deg,-30,30,265,350);
   pca9685.setPWM(SER2,0,servo2);

   servo3_deg=SS_servo3[node]/3.14159265*180;
   servo3=map(servo3_deg,-30,30,265,360);
   pca9685.setPWM(SER3,0,servo3);

   servo4_deg=SS_servo4[node]/3.14159265*180;
   servo4=map(servo4_deg,30,-30,265,360);
   pca9685.setPWM(SER4,0,servo4);
 
   servo5_deg=SS_servo5[node]/3.14159265*180;
   servo5=map(servo5_deg,30,-30,250,345);
   pca9685.setPWM(SER5,0,servo5);

   servo6_deg=SS_servo6[node]/3.14159265*180;
   servo6=map(servo6_deg,-30,30,260,355);
   pca9685.setPWM(SER6,0,servo6);

   servo7_deg=SS_servo7[node]/3.14159265*180;
   servo7=map(servo7_deg,-30,30,265,365);
   pca9685.setPWM(SER7,0,servo7);
  
  }
}
